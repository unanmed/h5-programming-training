# 第二章 第九节 调试

## 什么是调试 为什么要调试

调试的英文是`debug`，我们都知道`bug`是什么意思，而`debug`就是把`bug`干掉的意思，所以`debug`就是一个`修bug`的过程。所以，调试在编程中是一个非常重要的能力

## 控制台 console

浏览器为我们提供了强大的调试工具——控制台，这样我们可以使用console对象来进行调试，这里我们一一列举常用方法

### console.log

这个是我们一开始就讲的方法，不过这里我们要进行拓展

语法：`console.log(...information)`

#### 输出类型

在学完对象之后，我们应该知道了js中拥有的六种常见类型——`number` `string` `boolean` `undefined` `object` `function`，而它们在控制台输出时的效果是不一样的，我们一一来看

##### 一 number

`number`类型的数据输出时会呈现 <font style='color:rgb(160,3,171)'>_蓝色_</font>

![number](https://h5mota.com/bbs/images/b8ef2467efc796d739e79cf61fd47fc291b5f88f.png)

##### 二 string

`string`类型的数据输出时会呈现 _黑色_

![string](https://h5mota.com/bbs/images/83fe3eba48f718ab104749b28e33bbbf8e0bebb9.png)

##### 三 boolean

`boolean`类型的数据输出时也会呈现 <font style='color:rgb(160,3,171)'>_蓝色_</font>

![boolean](https://h5mota.com/bbs/images/f6291ecc6574a36aa26734ffcb5ab6c9b46a193f.png)

##### 四 undefined & null

虽然`null`的类型是`object`，但是这里我们将`null`和`undefined`放在一起

这两个数据在输出时都会显示 <font style='color:rgb(167,133,168)'>_灰色_</font>

![undefined](https://h5mota.com/bbs/images/d0fa4f91f1949f0fffdced5cf32c3235c4d92986.png)

![null](https://h5mota.com/bbs/images/3d6d72098f699cc904f1b77f7f4e8c9565b139a8.png)

##### 五 数组 & 对象 & 函数

这三个是一目了然的，直接上图（注意数组的类型是`object`）

![array](https://h5mota.com/bbs/images/e898f272175532bdeb293477c0c76d16bdf8a225.png)

![object](https://h5mota.com/bbs/images/716703108618ad4f9f1977b6690ddded0026aa58.png)

![function](https://h5mota.com/bbs/images/e878aea493cda6e8140822fba7f6ec4bb9d64530.png)

#### 输出样式

`console.log`还有另一个极其强大的功能，它允许你修改输出样式，也就是某些css特效。这里不在赘述，有兴趣的可以看[mdn文档](https://developer.mozilla.org/zh-CN/docs/Web/API/Console#outputting_text_to_the_console)

### console.warn

和`console.log`类似，不过变成了警告语句

### console.error

输出一条错误语句，和`console.log`差不多

### console.time & console.timeEnd

这两个函数允许你获取某一段代码的执行时间，从而进行代码优化

用法：`console.time(label)` `console.timeEnd(label)`

在运行时，当程序遇到`console.time`时，会开始计时，直到遇到相同`label`的`console.timeEnd`，停止计时并输出时间

![time](https://h5mota.com/bbs/images/d79b2fc42ed59e449e7350e2c20a6465ec9dc091.png)

### console.dir

这个功能会在学dom时用到，可以将`HTML元素`输出为一个对象

![dir](https://h5mota.com/bbs/images/59bda6027ead201a6e27e3b8cfad57105cb0106a.png)

## 源代码 source

当然，有时候我们只用控制台会不够用，所以，浏览器还允许我们使用`source`来进行调试

### 认识source界面

`source`的位置如下

![loc](https://h5mota.com/bbs/images/fba5bee81620b9cd2cdcffa60f422ed19dc919b3.png)

打开浏览器，我们可以看到如下界面

![source](https://h5mota.com/bbs/images/d8b4acc0790e16c573d9d6b8776f522b2fb89140.png)

在这个界面中，左边是文件浏览系统，右边是源代码显示区域

然后我们可以随意打开一个文件（不要在网站上尝试，因为网站上的代码是经过压缩的，什么也看不懂）

![file](https://h5mota.com/bbs/images/5e7360e4819b4f6e98d0e2143573f0578e78771a.png)

这就是打开文件后的页面了，右边我们可以看到源代码

### 断点调试

`source`界面最有用的功能，没有之一

我们打开文件后（一般是js文件），可以点击行数来打断点

![point](https://h5mota.com/bbs/images/e2f3af3df9932bcc346dfeddb423ec020d7b2efb.png)

然后显示蓝色的位置便是断点的精确位置。当程序执行时，当用户在开启控制台的情况下，如果遇到了断点，那么将会暂停执行，如下图

![pause](https://h5mota.com/bbs/images/48859f45f704c89b431578b8ebf9b556f0f339da.png)

这时，我们可以注意到`source`界面发生了巨大的变化，尤其是下方。下面我们会一一讲解

#### 一 作用域

就是这个界面

![scope](https://h5mota.com/bbs/images/1fc1e3ebf77fcf5730627508da8d50c8b41ee2be.png)

我们可以看到，这里有两个选项，一个是本地，另一个是全局

1. 本地，这个指正在执行的函数可以直接读取到的非全局 变量 | 常量 
2. 全局，顾名思义，全局变量

在本地栏中，我们可以查看当前的变量情况，从而确定程序运行情况是否如我们所愿，从而找到程序存在的问题

全局栏一般不会用到，这里不再描述

#### 二 断点

这个界面

![breakpoint](https://h5mota.com/bbs/images/2fea5137af7d124614d533624e4d4a490d9879bb.png)

这个界面会显示你当前打下的所有断点，点击旁边的勾可以禁用断点，再次点击可以启用

#### 三 调用堆栈

这里

![callstack](https://h5mota.com/bbs/images/9d2517a7b452f47e8a5ccdd5d0a6eb00b80deb34.png)

在这里，你可以找到函数的调用堆栈。简单点说，就是你可以找到函数的调用根源，也就是函数是怎么一步步调用到这里来的

比如上图，`resetGame`函数就是从`core.hideStartAnimate`到`control.hideStartAnimate`再到`utils.hideWithAnimate`然后通过`setInterval`异步函数，再经过两次匿名函数回调，到达`events.startGame_start`，再到`core.resetGame`，再到`events.resetGame`，最终到达正在执行的函数`resetGame`

如果上面的不好理解，可以理解为`resetGame`由`events.resetGame`调用，`events.resetGame`由`core.resetGame`调用...以此类推

#### 四 工具栏

这个地方

![tools](https://h5mota.com/bbs/images/269f29835527b0910280952a63a3a64ee4c20bdf.png)

常用的是前两个

第一个按钮意思是继续执行代码，直到遇到下一个断点，快捷键F8

第二个按钮意思是执行下一行代码，保持暂停状态，快捷键F10

后面的不太常用，我们不再介绍，有兴趣可以自己研究一下

#### debugger

`debugger`是一个js中的关键词，写在程序中即可打断点。程序在运行时，当运行到`debugger`关键词处时，如果用户开启了控制台，则会暂停运行，与断点效果相同，没有开启则直接忽略。具体用法如下

```js
var x = 100;
while (--x) {
    if (x === 50) debugger;
}
```

是的，直接写一个`debugger;`即可。在codelab中，由于不能直接打断点，所有只能使用`debugger`，在codelab中，使用方法为在断点处写一个`// @debugger`来打断点，并在调试模式下执行

## 性能 performance

有时候，我们会遇到程序很卡的情况，这时候就要让性能这一栏出场了，它可以帮助我们录制程序运行过程中的所有函数调用及运行时间，从而允许我们进行优化

### 界面概览

如图

![performance](https://h5mota.com/bbs/images/0c37036614a211f4227eda370f535f6fea31c04d.png)

就目前来看，该界面有用的地方是在上面，我们对上面的按钮一一介绍

### 一 录制 & 停止 & 录制文件管理

在左上角这里

![record](https://h5mota.com/bbs/images/ff5e794e9a85a219b0d42e1a075e9d13f9261312.png)

第一个按钮是开始录制性能。第二个是录制加载性能，点击后会立刻刷新页面，然后开始录制，当页面加载完毕后会自动停止录制。第三个是删除当前录制内容。第四个是从本地文件读取录制内容。第五个是将当前录制内容存入本地，录制时长越长，文件越大

### 二 录制选项

在右上角

![setting](https://h5mota.com/bbs/images/5b0fb541125e2c59ed8c5dc6958b0094d274d6a5.png)

这个设置就要看个人喜好了，我不喜欢用屏幕截图。在录制时内存均会录制，勾上则显示内存，不勾则不显示

### 三 录制内容

录制完毕后我们等待一会，便可以得到一个性能分析报告

![recorded](https://h5mota.com/bbs/images/3822df50779022e6ca8dbb84c7ab9eb3d7b72cbe.png)

这个页面可能看着很乱，但实际上很有条理，我们一一解释

![summery](https://h5mota.com/bbs/images/cd193a887837913009062c0ef67ce620c9d8e950.png)

在下方有一个摘要，这里显示了我们录制的这一段时间中所有的操作耗时，从这里我们就可以大致看出来我们需不需要对这一阶段进行代码优化

![up](https://h5mota.com/bbs/images/c7e9288f9dc455f6a1962e72ee49e1153b3328bc.png)

上方便是本次录制的详细信息了，我们逐行进行解析

1. 第一行，很明显，是当前时间段的帧数
2. 当前阶段的cpu使用情况，颜色代表执行不同的内容，与摘要中的颜色相对应，比如黄色代表执行脚本，绿色代表绘制，蓝色代表渲染等
3. 下面这里有一个很细的一行，是网络情况，代表当前时间段的网络使用情况
4. 再下面是内存，右边有一个数字显示，代表当前占用的内存的值域
5. 下面是网络和帧数的详细信息，以及互动和体验，这些目前用不到，而且之后用到的概率也很小
6. 下面就是我们的重头戏了，函数调用的详细信息

我们可以将鼠标放到某个函数调用上面来查看简略信息

![brief](https://h5mota.com/bbs/images/7863b0422977f53b5ac0d463b6c565fd11e731da.png)

我们还可以点击这个函数调用来查看它的详细信息，在下方我们就可以看到摘要

![summery2](https://h5mota.com/bbs/images/755e99e5e69fae7692cd28b71aac1a48850c0a19.png)

当然，这么点东西肯定不够用，我们需要更强大的工具——调用树`call tree`

打开后我们可以看到只有一行

![oneline](https://h5mota.com/bbs/images/fe229feb12c880e78b70ce1305d440bf5a39c09f.png)

这里，左面分别是本函数的自身执行时间（也就是不包括该函数内部调用的函数的执行时间）以及该函数的总执行时间，一般我们只会看总执行时间。右边便是当前正在执行的函数名，我们可以点击左边的箭头一级级向下展开

![unfold](https://h5mota.com/bbs/images/6346b9bc012b8eb797309167b267c0c711c3cdac.png)

在这里，函数的调用顺序为正常顺序，即上面的调用了下面的，与断点中的调用堆栈相反。在上面这个图中，我们清晰地看到，`core.drawThumbnail`这个函数花费时间最长，我们就可以考虑从这里进行优化。一般情况下，优化有两种方案：一是直接对函数进行优化，减少函数的运算量，二是减少函数的调用次数，比如样板中的`updateStatusBar`

当然，我们还可以分得更细一点，直到不能再向下展开

![moredetailed](https://h5mota.com/bbs/images/220db4c7f93d986118b255d9ae94da1cbc3e491b.png)

我们还可以选中某一段录制内容，把这一段的内容放大

![enlarge](https://h5mota.com/bbs/images/96522678ae8b6e3ac40af0fcd15efae8b78e71b5.png)

以及录制加载性能

![load](https://h5mota.com/bbs/images/96f480da5705d928ef7d1e0d2fbf0ba8a68e5dcd.png)

## try catch throw

这三个是js中非常重要的三个关键字，用途很广

### try catch

一般情况下，这两个是会同时出现的，用法如下

```js
try {
    var x = 0;
    x++;
} catch (error) {
    console.error(error);
}
```

在这里，`try`是指尝试运行紧接着的代码块，如果运行时遇到错误，则停止执行该代码块，并将错误作为一个类似于变量的东西，通过`catch`后面的括号传入下面的代码块，执行`catch`里面的内容

在这里，很明显，`try`里面没有错误，`catch`里面的内容便不会执行。再看另一个例子

```js
try {
    var a;
    console.log(a.toString())
} catch (e) {
    console.error('代码块中的内容执行出错！！\n错误信息为：\n' + e);
}
```

很明显，这里我们只声明了`a`，并没有赋值，就不存在`toString`方法，在执行时便会报错`Uncaught TypeError: Cannot read properties of undefined (reading 'toString')`，然后立刻停止`try`中的内容的执行，将该错误信息转到`e`中，执行`catch`中的内容，最后输出内容为

`代码块中的内容执行出错！！`

`错误信息为：`

`Uncaught TypeError: Cannot read properties of undefined (reading 'toString')`

`    at <anonymous>:1:3`

`（匿名） @ VM237:1`

### throw

`throw`这个关键字随时可以出现，不一定在`try`中，它的作用和`console.error`类似，但有一点不同，那就是会立刻停止正在执行的函数或代码块的运行，例如

```js
console.log(1);
throw 123;
console.log(2);
```

这样，程序便会在输出`1`以后抛出一个错误`Uncaught 123`，然后`2`并没有被输出

## 元素 element

该界面会在讲完`html`和`dom`后再进行讲解，这里不再讲解